<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>contentsculptable</title>
  <style>
    [contenteditable] {
      border: 1px solid #ddd;
      color: #444;
      font-size: 18px;
      font-family: Georgia;
      min-height: 100px;
      outline: none;
      width: 500px;
    }
    .hidden {
      display: none;
      opacity: 0;
    }
    .subtle {
      opacity: 0.3;
    }
  </style>
</head>
<body>
  <div></div>
  <script src="../dist/contentsculptable-bundle.js"></script>
  <script>
    var el = document.querySelector('div');
    var view = new contentsculptable.ViewModel(el);
    var model = view.textModel;

    function wrapMatch(tagName) {
      return function(match, forEditing) {
        var i = match.index;
        var el = view.wrapText(i, i + match[0].length, tagName);
        var tag = forEditing ? 'span.subtle' : 'span.hidden';
        view.wrapText(i, i + match[1].length, tag);
        view.wrapText(i + match[0].length - match[1].length, i + match[0].length, tag);
      };
    }

    var patterns = [
      /(\*\*)(?!\s).*(\*\*)/, wrapMatch('b'),
      /(\_\_)(?!\s).*(\_\_)/, wrapMatch('b'),
      /(\*)(?![\*,\s]).*(\*)/, wrapMatch('i'),
      /(\_)(?![\_,\s]).*(\_)/, wrapMatch('i')
    ];

    model.on('change', function foo() {
      var text = el.textContent = model.getValue();
      for (var i = 0; i < patterns.length; ++i) {
        var p = patterns[i];
        var fn = patterns[++i];
        var match = text.match(p);
        if (match) {
          var end = match.index + match[0].length;
          var c = model.getCursor();
          var editing = match.index <= c && c <= end;
          fn(match, editing);
        }
      }
      view.restoreSelection();
    });
  </script>
</body>
</html>
